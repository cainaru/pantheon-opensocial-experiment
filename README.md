# pantheon-opensocial-experiment

[![CircleCI](https://circleci.com/gh/cainaru/pantheon-opensocial-experiment.svg?style=shield)](https://circleci.com/gh/cainaru/pantheon-opensocial-experiment)
[![Dashboard pantheon-opensocial-experiment](https://img.shields.io/badge/dashboard-pantheon_opensocial_experiment-yellow.svg)](https://dashboard.pantheon.io/sites/c4111088-1d00-4b05-a345-7b84920181a3#dev/code)
[![Dev Site pantheon-opensocial-experiment](https://img.shields.io/badge/site-pantheon_opensocial_experiment-blue.svg)](http://dev-pantheon-opensocial-experiment.pantheonsite.io/)

## About this project

This is an experimental attempt to fuse together Pantheon's latest [Example Drops 8 Composer](https://github.com/pantheon-systems/example-drops-8-composer) repository and the latest version of the installation profile for [Open Social](https://github.com/goalgorilla/open_social). 

The goal behind this is to take advantage of the awesomeness of Pantheon's [Build Tools workflow](https://pantheon.io/docs/guides/build-tools/) with Open Social as the site's installation profile. 

By default, Example Drops 8 Composer installs the standard profile as well as exports and commits the site's configuration. Originally, I figured I could easily pull my newly-generated site into my local environment to modify its composer.json file based on the steps outlined in [Updating Open Social to 1.5 with Composer](https://www.drupal.org/docs/8/distributions/open-social/updating-open-social-to-15-with-composer) and push the changes back up, but I ran into lots of issues with CircleCI tests failing as well as the “The staged configuration cannot be imported, because it originates from a different site than this site. You can only synchronize configuration between cloned instances of this site.” error message when going to /admin/config/development/configuration in the development environment. 

It took a lot of tinkering, researching and trial-and-erroring, but I came to the conclusion that things would probably go smoother if the project template I was using to automagically generate my Open Social Pantheon site via Pantheon's [Build Tools workflow](https://pantheon.io/docs/guides/build-tools/) was prepped to support Open social from the start. That way, there would be no need to fuss around with mismatched configuration after export and issues with tests failing. Hence, this project was born.

Note: as a garden-variety Drupal sitebuilder, I might have made some novice mistakes in the steps I took to create this project, but this has served as a great learning experience. If anyone has any feedback, helpful tips, or suggestions feel free to reach out!

## Steps to reproduce

These are the steps I took to create this project.

### Initial prep

1. `composer create-project pantheon-systems/example-drops-8-composer pantheon-opensocial-experiment`
1. `cd pantheon-opensocial-experiment`
1. `nano .gitignore` and find the section containing:

    ```
    ###
    ### GitHub repository .gitignore section
    ###

    # Ignore directories generated by Composer
    /drush/contrib/
    /vendor/
    /web/core/
    /web/modules/contrib/
    /web/themes/contrib/
    /web/profiles/contrib/
    /web/private/scripts/quicksilver
    ```
    
1. Add `/web/libraries/` into that section, so that it looks like this:

    ```
    ###
    ### GitHub repository .gitignore section
    ###

    # Ignore directories generated by Composer
    /drush/contrib/
    /vendor/
    /web/core/
    /web/libraries/
    /web/modules/contrib/
    /web/themes/contrib/
    /web/profiles/contrib/
    /web/private/scripts/quicksilver
    ```
    
1. `nano composer.json` and find the following section:

    ```
    "minimum-stability": "alpha",
    "prefer-stable": true,
    "autoload": {
      "classmap": [
        "scripts/composer/ScriptHandler.php"
      ]
    },
    ```
    
1. In the above section, modify `"minimum-stability": "alpha"` to `"minimum-stability": "dev"`, so that it looks like this:

    ```
    "minimum-stability": "dev",
    "prefer-stable": true,
    "autoload": {
      "classmap": [
        "scripts/composer/ScriptHandler.php"
      ]
    },
    ```
    
1. `composer update drupal/core --with-dependencies` so Drupal 8 is up-to-date (as of writing this, Example Drops 8 Composer installs Drupal core 8.5.1, which is behind the latest release of 8.5.3)

#### Modify `settings.php` to install `social` instead of `standard` profile

1. `nano web/sites/default/settings.php` and find `$settings['install_profile'] = 'standard';`. Change to `$settings['install_profile'] = 'social';`


#### Modify `composer.json` to support Open Social

The steps listed here are adapted from [Updating Open Social to 1.5 with Composer](https://www.drupal.org/docs/8/distributions/open-social/updating-open-social-to-15-with-composer).

1. `nano composer.json` and find the following section:

    ```
    "repositories": [
      {
        "type": "composer",
        "url": "https://packages.drupal.org/8"
      }
    ],
    ```
    
1. Change the above section to this:

    ```
    "repositories": [
      {
        "type": "composer",
        "url": "https://packages.drupal.org/8"
      },
      {
        "type": "composer",
        "url": "https://asset-packagist.org"
      }
    ],
    ```

1. Find the following section:

    ```
    "extra": {
      "installer-paths": {
        "web/core": ["type:drupal-core"],
        "web/modules/contrib/{$name}": ["type:drupal-module"],
        "web/profiles/contrib/{$name}": ["type:drupal-profile"],
        "web/themes/contrib/{$name}": ["type:drupal-theme"],
        "drush/contrib/{$name}": ["type:drupal-drush"]
      },
    ```

1. Add installer-types above installer-paths:

    ```
    "extra": {
      "installer-types": [
        "bower-asset",
        "npm-asset"
      ],
      "installer-paths": {
        "web/core": ["type:drupal-core"],
        "web/modules/contrib/{$name}": ["type:drupal-module"],
        "web/profiles/contrib/{$name}": ["type:drupal-profile"],
        "web/themes/contrib/{$name}": ["type:drupal-theme"],
        "drush/contrib/{$name}": ["type:drupal-drush"]
      },
    ```

1. Add the libraries path into the installers-path section:

    ```
    "extra": {
      "installer-types": [
        "bower-asset",
        "npm-asset"
      ],
      "installer-paths": {
        "web/core": ["type:drupal-core"],
        "web/modules/contrib/{$name}": ["type:drupal-module"],
        "web/profiles/contrib/{$name}": ["type:drupal-profile"],
        "web/themes/contrib/{$name}": ["type:drupal-theme"],
        "web/libraries/{$name}": [
          "type:drupal-library",
          "type:bower-asset",
          "type:npm-asset"
        ],
        "drush/contrib/{$name}": ["type:drupal-drush"]
      },
    ```

1. Find the following section:

    ```
    "drupal-scaffold": {
      "source": "https://raw.githubusercontent.com/pantheon-systems/drops-8-scaffolding/{version}/{path}",
      "includes": [
        "sites/default/default.services.pantheon.preproduction.yml",
        "sites/default/settings.pantheon.php"
      ],
      "excludes": [
        ".csslintrc",
        ".editorconfig",
        ".eslintignore",
        ".eslintrc.json",
        ".htaccess",
        "web.config"
       ]
    }
    ```

1. Add `"enable-patching": true` below the above section:

    ```
    "drupal-scaffold": {
      "source": "https://raw.githubusercontent.com/pantheon-systems/drops-8-scaffolding/{version}/{path}",
      "includes": [
        "sites/default/default.services.pantheon.preproduction.yml",
        "sites/default/settings.pantheon.php"
      ],
      "excludes": [
        ".csslintrc",
        ".editorconfig",
        ".eslintignore",
        ".eslintrc.json",
        ".htaccess",
        "web.config"
       ]
    },
      "enable-patching": true
    ```

#### Modify `composer.json` once more!


1. `nano composer.json` and find the following section:

    ```
    "build-env": {
      "install-cms": [
        "drush site-install standard --account-mail={account-mail} --account-name={account-name} --account-pass={account-pass} --site-mail={site-mail} --site-name={site-name} --yes",
        "drush pm-enable config_direct_save simple_block --yes",
        "drush pm-uninstall block_content --yes"
      ],
      "export-configuration": "drush config-export --yes"
    },
    ```
    
1. In the above section, replace `drush site-install standard` with `drush site-install social`, and also remove `drush pm-enable config_direct_save simple_block --yes` and `drush pm-uninstall block_content --yes`, so that it looks like this:

    ```
    "build-env": {
      "install-cms": [
        "drush site-install social --account-mail={account-mail} --account-name={account-name} --account-pass={account-pass} --site-mail={site-mail} --site-name={site-name} --yes"
      ],
      "export-configuration": "drush config-export --yes"
    },
    ```
    
#### Modify `content.feature` Behat tests
 
In `/tests/features/content.feature`, modify the following tests:
 
1. Find the following section:
 
    ```
    @api
    Scenario: Create many nodes
      Given "page" content:
      | title    |
      | Page one |
      | Page two |
      And "article" content:
      | title          |
      | First article  |
      | Second article |
      And I am logged in as a user with the "administrator" role
      When I go to "admin/content"
      Then I should see "Page one"
      And I should see "Page two"
      And I should see "First article"
      And I should see "Second article"
    ```
    
1. Replace with:

    ```
    @api
    Scenario: Create many nodes
      Given "page" content:
      | title    |
      | Page one |
      | Page two |
      And "topic" content:
      | title        |
      | First topic  |
      | Second topic |
      And I am logged in as a user with the "administrator" role
      When I go to "admin/content"
      Then I should see "Page one"
      And I should see "Page two"
      And I should see "First topic"
      And I should see "Second topic"
    ```
    
1. Find the following section:
 
    ```
    @api
    Scenario: Login as a user created during this scenario
      Given users:
      | name      | status | mail             |
      | Test user |      1 | test@example.com |
      When I am logged in as "Test user"
      Then I should see the link "Log out"
    ```
    
1. Replace with:
 
    ```
    @api
    Scenario: Login as a user created during this scenario
      Given users:
      | name      | status | mail             |
      | Test user |      1 | test@example.com |
      When I am logged in as "Test user"
      Then I should see the link "Logout"
    ```
    
1. Finally, find the following sections:
 
    ```
    @api
    Scenario: Create many terms
      Given "tags" terms:
      | name    |
      | Tag one |
      | Tag two |
      And I am logged in as a user with the "administrator" role
      When I go to "admin/structure/taxonomy/manage/tags/overview"
      Then I should see "Tag one"
      And I should see "Tag two"

    @api
    Scenario: Create nodes with specific authorship
      Given users:
      | name     | mail            | status |
      | Joe User | joe@example.com | 1      |
      And "article" content:
      | title          | author   | promote |
      | Article by Joe | Joe User | 1       |
      When I am logged in as a user with the "administrator" role
      And I am on the homepage
      Then I should see the link "Article by Joe"
      When I follow "Article by Joe"
      Then I should see the text "Article by Joe"
    ```
    
1. Replace with:
 
    ```
    @api
    Scenario: Create many terms
      Given "interests" terms:
      | name         |
      | Interest one |
      | Interest two |
      And I am logged in as a user with the "administrator" role
      When I go to "admin/structure/taxonomy/manage/interests/overview"
      Then I should see "Interest one"
      And I should see "Interest two"

    @api
    Scenario: Create nodes with specific authorship
      Given users:
      | name     | mail            | status |
      | Joe User | joe@example.com | 1      |
      And "topic" content:
      | title        | author   | promote |
      | Topic by Joe | Joe User | 1       |
      When I am logged in as a user with the "administrator" role
      And I am on the homepage
      Then I should see the link "Topic by Joe"
      When I follow "Topic by Joe"
      Then I should see the text "Topic by Joe"
    ```
    
### Using Terminus to build the site
 
This is when the real magic happens. If you haven't yet installed [Terminus](https://pantheon.io/docs/terminus/install/), the [Terminus Build Tools Plugin](https://github.com/pantheon-systems/terminus-build-tools-plugin), setup an account with Github, and/or setup an account with CircleCI, please refer to the Example Drops 8 Composer [Prerequisites](https://github.com/pantheon-systems/example-drops-8-composer#prerequisites).

Once all of the prerequisites are in place, `cd ..` out of your `pantheon-opensocial-experiment` directory and run the following command:

```
terminus build:project:create ./pantheon-opensocial-experiment the-name-of-your-site
```

Follow and answer any subsequent prompts, such as the password for logging into the site, the Organization (if any), and the GitHub and CircleCI tokens.

Once the site is built, the link to its Github repository will be printed in your terminal window. 

## Resources and Guides Used

I used information from the following links to help guide me along the way

https://github.com/pantheon-systems/example-drops-8-composer/pull/93
https://github.com/pantheon-systems/example-drops-8-composer/tree/contenta--take2--install-hack
https://github.com/pantheon-systems/terminus-build-tools-plugin/issues/43
https://github.com/goalgorilla/open_social
https://github.com/goalgorilla/social_template/blob/master/composer.json
https://github.com/pantheon-systems/terminus-build-tools-plugin
https://pantheon.io/docs/guides/drupal-8-commerce/
https://github.com/lquessenberry/OpenSocialOnPantheon/blob/master/composer.json <--- Note: super outdated, uses CircleCI 1.0 and very different structure, but a good reference material nonetheless
